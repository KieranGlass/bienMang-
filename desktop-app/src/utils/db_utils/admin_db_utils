import sqlite3
from contextlib import closing

import tkinter as tk
from tkinter import messagebox

from . import common_db_utils


def submit(self):
        username = self.username_entry.get().strip()
        password = self.password_entry.get().strip()
        if username and password:
            conn = conn = common_db_utils.get_db_connection()
            cursor = conn.cursor()

            try:
                cursor.execute("""
                    INSERT INTO users (username, password, is_admin, is_active)
                    VALUES (?, ?, 1, 1)
                """, (username, password))

                # Deactivate master
                cursor.execute("UPDATE users SET is_active = 0 WHERE username = 'master'")
                conn.commit()
                tk.messagebox.showinfo("Success", "Admin created and master disabled.")
            except sqlite3.IntegrityError:
                tk.messagebox.showerror("Error", "Username already exists.")
            finally:
                conn.close()
        else:
            tk.messagebox.showwarning("Input Error", "Username and password required.")